# 設計ノート
このノートは当該機器の電子回路設計の履歴や設計意図を記録しています。</br>
回路動作の理解や改善・修理などにご利用ください

## 修正履歴
- 初版：2025/06/01  宮本政和

# 設計の概要
## ブロック図

## 設計のポイント
- **バッテリ動作**  
  単三バッテリ4本で動作するように設計しました。  
  ACでの駆動は磁気計測環境に対してノイズを導入する可能性があるため、信頼性の高い計測が必要なキャリブレーションには向かないと判断しました。
  コイルドライブ部の駆動電圧は3.3Vですが、出力をプッシュプル構成とすることで動作電圧が低いという欠点を補っています。

- **DDSを発振器として利用**  
  <!-- 従来のコイルドライバではアナログの発振器を使用していましたが、この設計ではDDSに変更しました。  
  これにより周波数変更作業が容易になります。従来、周波数変更のためには発振回路の抵抗器の交換が必要でしたが、この設計ではCPLDに書き込むHDLの変更（ソフトでの対応）で済む様になりました。
  一方、DDSは高周波で動くデジタル回路ですので、コイルドライブ回路へのノイズの流入に注意して設計しました。  
  アナログの発振回路も回路図上は残っていますので、必要に応じて利用可能です。 -->

  従来のコイルドライバではアナログ発振回路を用いていましたが、本設計ではDDSを採用しました。これにより、周波数変更がソフトウェアで完結するため、アナログ回路の抵抗交換が不要になり、周波数の変更にも容易に対応できます。
  一方で、DDSは高速なデジタル回路であるため、アナログ回路であるコイル駆動回路へのノイズ影響を最小限に抑えるよう配慮して設計しました。  
  アナログ発振回路も残しているため、用途に応じて使い分けることが可能です。

- **コイル駆動電流を計測できる様にモニタ端子を用意**   
  キャリブレーション作業では、コイルに流れる電流を計測する必要があります。そのための電流モニタ回路を用意しました。
  コイルに流れる電流値をアナログ電圧として計測することが可能です。さらに、実際にコイルに流れている電流を別法により計測することで、電流モニタ回路出力の値を校正（値付け：あたいづけ）することができます。
  電流モニタ回路は安定した計測結果を得るために、温度特性に優れた部品を使っています。
  
# 各部の詳細設計
この設計では機能を実現する回路を大きく3つに分ています。DDS回路、本体回路、ユーザインタフェース用回路です。  
以下の順を追って各回路の設計について解説します。

## 発振回路(DDS)

### 設計のポイント
コイルを駆動する信号を生成するためのDDS回路です。  
<!-- 
発振回路そのものは市販のモジュールを利用しています。DDSでは周波数決定のためのレジスタに設定する値と、デバイスに接続している水晶発振子の発振周波数から出力される信号の周波数が決定されます。そのため例えば、周波数設定値のLSB1ビット分を0.1Hzにする、と言ったような「キリのいい」設定にしようとすると、水晶発振子の周波数が2^24/10のような値になってしまい、標準的でない「特注周波数」での購入になってしまいます。そうするとコストも納期もかかってしまうので、市販のモジュールを使用することにしました。  
使用したモジュールは ストロベリーLinuxという会社の「AD9834 小型DDSモジュールキット」という製品で、AnalogDevicesのAD9384というDDS-ICと特注の水晶発振子を実装しており、周波数設定の1LSBあたり0.25Hzとキリのいい周波数設定で出力信号の周波数を設定できるようになっています。  
また、出力信号が差動で得られるのでノイズ対策にも有利です。 -->
DDSは、周波数決定レジスタに設定する値と基準クロック周波数（水晶発振子）によって出力周波数が決まります。しかし、周波数設定の分解能（1LSB）をキリの良い値（例えば0.1Hz）にしようとすると、基準クロック周波数が非標準的な値になってしまい、特注の水晶発振子が必要となります。これはコスト増や納期遅延の原因となるため、水晶発振子が実装済みの市販モジュールを利用することにしました。  
採用したのは、ストロベリー・リナックス社の「AD9834 小型DDSモジュールキット」です。このモジュールは、Analog Devices社のDDS-IC「AD9834」と特注の水晶発振子を搭載することで、周波数分解能を0.25Hz/LSBという扱いやすい値に設定しています。  
また、差動出力に対応しているため、ノイズ対策の面でも有利です。

### デバイス仕様・定数の決定
回路図にはこのDDSモジュールの設定について記載していないので、ここに記載しておきます。
- メーカ、品名：[ストロベリーLinux　AD9834 小型DDSモジュールキット](https://strawberry-linux.com/catalog/items?code=57090)
- 周波数設定：CPLDのプログラミングによる（デフォルト：80Hz）
- 出力信号：差動出力　0.25Vo-p
  - これを本体側の差動アンプ（ゲインx1）回路で受けるので、本体側の信号レベルとしては2倍の1Vp-p(=0.5Vo-p)になります。
  - 出力設定のために、本体上の出力電圧設定抵抗（FSADJ端子につながっている6.8kΩの抵抗）を取り外し、8.66kΩ(=9.1kΩ//180kΩ)を取り付けます。
  - 信号はDDSモジュール上のSMBコネクタのパターン上からリード線を引き出しDF11コネクタを取付け、本体回路のCN1と接続しています。
- 電源電圧：3.3V
  - モジュール自の仕様としては電源電圧5Vです。初期の設計でDDSを5V動作に設定して動作確認したところ、CPLDのIO電圧が3.3VであるためDDSがCPLDからのコマンドを受け取れないという状況になりました。そのため、3.3V動作としています。
  - 使用しているDDSデバイスの電源範囲は2.3〜5.5Vなので問題ないですが、使用している水晶発振器の電源電圧が5Vとなっています。実際に動作テストを行い、3.3Vでも問題ないことを確認してこの電源電圧で使用しています。

### 組み立て
- 本体回路と接続するため付属のコネクタ（ピンフレーム：ピンヘッダが嵌合するメスのコネクタ）をはんだ付けします。部品面にコネクタを実装し、ハンダ面からはんだ付けします。
- SMAコネクタが付属していますが使用（実装）しません。
- 出力電圧設定のため、実装されているR1を取り外し180kΩを取り付けます。さらにリード抵抗で9.1kΩをR1にパラに接続します。
- IOUTとIOUTB端子にケーブルをはんだ付けし、ツイストさせてDF11コネクタ4ピンメスを接続します。

## 本体回路
本体の回路は以下のような機能が実装されています。

- アナログ発振回路（未使用）
- 外部入力回路（未使用）
- DDS信号入力回路
- 入力選択回路（固定で使用）
- シーケンス駆動用クロック信号生成回路（コンパレータ）
- ドライブ回路／電流設定回路
- 電流検出回路
- 中間電位生成回路
- バッテリ電圧監視回路
- 電源回路
- マルチプレクサ回路
- ユーザインターフェイス回路
- 同期信号出力回路
- DDSインターフェイス
- シーケンス回路（CPLD/HDL）

以下に、各部の設計の詳細について記載します。

## 回路図 1/4
<img src="/figures/ER-524D_CoilDriver24_SCH_P1_function.png" alt="CKT_page1" width="800px">

### アナログ発振回路（未使用） (U1A,U1B)
コイルを駆動する信号を生成するアナログの発振回路です。今回の設計では使いませんが、旧バージョンとのコンパチビリティのために基板上にパターンが存在します。  
部品を実装すれば利用可能です。発振可能な周波数範囲としては10Hzぐらいから20kHz程度かと思います。ドライブ回路ではノイズ対策のためLPFが入っていますので、周波数を変更する場合はその調整も行ってください。  
出力電圧は1Vo-pに調整します。振幅電圧が低いと安定して発振できなくなります。

### 外部入力回路（未使用） (U2A)
コイルを駆動する信号を外部から入力するための回路です。差動アンプで受けることで外部の発振器からのノイズ流入を抑えています。  
0.5Vo-p入力時に設計した駆動電流となります。

### DDS信号入力回路 (U2B)
DDSのアナログ出力を受け取ります。DDSからのノイズ流入を防ぐため、GNDを直接接続しない差動アンプで受け取ります。差動アンプの利得は1倍ですが、DDSの出力も差動なのでDDSの設定電圧の2倍の電圧が出力されます。
ノイズを抑えるため、1kHz程度のLPFがかかっています。

### 入力選択回路（固定で使用） (U3-1,U3-2)
アナログスイッチを用いて、コイルを駆動する信号をCPLDの信号により選択します。DDS、アナログ発振回路、外部入力の3つの選択肢があります。  
今回の設計では、CPLD内部でDDSに固定されています。

### シーケンス駆動用クロック信号生成回路（コンパレータ） (U7)
複数のコイルを決まったパターンで順次ドライブするための、チャネルの切り替え信号などを生成するためのシーケンス回路が必要となります。そのシーケンス回路の動作タイミングの基準となるクロックを発振回路の出力信号から作成するのがこの回路です。  
単純なヒステリシス付きコンパレータで、発振回路の出力の正弦波から矩形波を作成し、CPLD内のシーケンス回路に渡します。  
ヒステリシスは41mVに設定してあります。このヒステリシスで現在のところ問題は発生していません。

### ドライブ回路／電流設定回路 (U5A,U10X,U8A,U8B)
入力選択回路からの正弦波はドライブ回路に入ります。入力電圧は0.5Vo-pです。  
アナログ発振回路からの信号は1Vo-pなので、入力で1/2にアッテネートされます。DDS入力の場合はそのまま入力されます。  
最初にU5AとU10Xの非反転アンプで出力電流設定に応じて、1倍もしくは2倍に振幅を増幅します。

その後、プッシュプル動作のドライブ回路(U8A,U8B)に信号が渡されます。ここでは1倍の反転アンプと1倍の非反転アンプの構成でプッシュプル（差動）出力の信号を作成します。ノイズ防止のため1.4kHz程度のLPFがかかっています。  
プッシュプル出力の信号はそれぞれU9のアナログスイッチを通して出力電流を決める抵抗に接続されます。ここでは２つの出力インピーダンスを切り替えて電流出力を設定しています。この設計では2つのインピーダンスの比は10倍です。  

電流の切り替えは、最初の非反転アンプU5Aでの電圧での切り替えと、この出力インピーダンスの切り替えの2箇所で行うことになります。それぞれ1bitの切り替え選択肢なので、4つの設定ができることになります。

この設計では定電流駆動回路の構成は取りませんでした。接続されるコイルが既知の仕様のものであり、インピーダンスが十分低いことがその理由です。定電流駆動回路は、負荷のインピーダンスが未知だったり、ばらつきが大きいものを安定して定電流で駆動することができます。その一方で回路が複雑になり信号に対する応答特性を考慮する必要があること、3.3Vという低電圧動作のため定電流駆動回路の利点が引き出せない可能性があることから、単純な高出力インピーダンスによる電流出力としました。

出力インピーダンスを下げることによってドライブ電流を上げることができますが、オペアンプのドライブ能力の点から5mA程度が最大となります。また、インピーダンスを下げるとコイル接続部の接触抵抗などによるドライブ電流誤差が大きくなると考えられます。  
ドライブ電流は計測できるので大きな問題にはならないと思いますが、計測の安定性や信頼性を考えるとコイルのインピーダンスの100倍程度の出力インピーダンスは維持した方がいいと思われます。

### 電流検出回路(U11)
コイルの駆動電流を検出する回路です。高精度の抵抗(100Ω)をコイル駆動出力に挿入し、高利得確度のインスツルメンテーションアンプICを利用してその両端の電圧を測ることで電流を測定することを可能にします。  
インスツルメンテーションアンプの利得は高安定度の抵抗2本の並列接続(R55,R57)で設定しています。これにより利得は50.33倍に設定されます。100Ωの電流検出抵抗を使っているので、電流電圧変換係数としては5033[V/I]となります。   
例えば10uAで駆動した場合、電流検出回路出力は50.33mVになります。

<!-- 電流電圧変換係数の誤差は、インスツルメンテーションアンプの利得誤差（0.3%最大）、利得設定抵抗の抵抗値誤差（0.05%最大）、電流検出抵抗100Ωの誤差(0.05%最大)から見積もれますが、これは理想的な状況を仮定した場合だと考えられます。実際には部品実装時の熱ストレスやハンダ付けによる機械的なストレスが加わっており、部品単体の仕様で提示された誤差よりも 大きくなる可能性があります。
完成後にコイル駆動電流値と電流検出回路の出力の電流の両方を同時に計測することにより電流電圧変換係数の値付をする必要があると考えます。
-->

インスツルメンテーションアンプのコモンモード電圧について検討してみます。
この回路の後段には24個のコイルを順次駆動するためのマルチプレクサが控えています。シーケンス回路によってコイルが切り替わる時にマルチプレクサがオフになり電流駆動回路がオープンになる時間があります。コイルがつながっていて電流駆動している場合、インスツルメンテーションアンプのコモンモード電圧は、電源電圧(3.3V)の中間電圧である1.65V程度になりますが、電流駆動が開放の場合はドライブ回路のオペアンプを通じて1.68V±1Vの電圧がかかることになります。  
データシートを見てみると、コモンモード電圧の最大は電源電圧−0.9Vとなっており、3.3Vの電源電圧だと2.4Vとなり、1.68V±1Vの入力があった場合には一部オーバーロードとなり出力信号が異常となってしまいます。そのためインスツルメンテーションアンプの電源のみ、3.3Vではなくバッテリから直接供給することとしました。   
バッテリはNi-MHを4本使用する設計としましたので、標準的には1.2x4=4.8V程度の電圧が期待でき、バッテリが減ってきた状態でセルあたりの電圧が1.1V程度に落ちたとしても、電源電圧4.4V程度ですのでコモンモード電圧の最大は3.5Vとなり、マルチプレクサがオフのコイルを電流駆動していない場合でも安定した出力を得られることになります。

この回路の出力はBNCコネクタを経由して外部の機器に接続されます。ケーブルの長さが長い場合(5mを超えるような場合)にインスツルメンテーションアンプの出力が発振するという現象があったので、出力インピーダンスを高く設定しています。接続する機器の入力インピーダンスに注意してください。

### 中間電位生成回路
オペアンプで構成した反転・非反転増幅回路の基準電圧を作るための回路です。  
電源電圧を抵抗分割で半分にして回路の基準電圧(1.65V)としています。この電位は電流検出回路の出力の中間電位設定用にも供給されていますが、駆動回路の動作時の電流流れ込みによる基準電位の変動を抑えるため、CRで分離しています。  

### バッテリ電圧監視回路
<!-- バッテリが消費されて電源電圧が低下したことを知らせるため、バッテリ電圧監視回路が実装されています。  
電圧監視の専用IC(U8:TPS3808G01)を利用し、アラーム発呼のスレッショルドを4.79Vとしました。
電池はNi-MH 単三型4本 の利用を前提としており、1本あたり1.2Vが規定の出力電圧です。スレッショルド電圧の4.79Vは電池1本当たりにすると1.1975Vとなり、1.2Vを切るぐらいのところでワーニングが出るようになります。"eneloop(容量:1.2V 2Ah)"を使った放電実験のwebサイトなどを参照すると、0.2Cの放電率で使用した場合、1.2Vを切ると急激に出力電圧が低下する様子が見て取れましたので、1本あたり1.2Vでワーニングが出るようにしました。  
実際の消費電流は10mA~20mA程度ですので2Ahのバッテリに対して放電率0.01C程度となり、バッテリ1個あたりの電圧1.2Vを切って使用し続けてもしばらくは動作するように思えます。 -->

本機器には、バッテリー電圧低下を知らせるための監視回路を実装しています。
監視ICには、TPS3808G01 (U8) を採用し、アラーム発生のスレッショルド電圧を 4.79V に設定しました。この値は、単三形Ni-MH電池4本を想定しており、電池1本あたりの電圧に換算すると 1.1975V となります。  
アラーム発生のスレッショルド電圧を決めるにあたり、Webサイトの放電実験データ（例：eneloop 1.2V 2Ah、放電率0.2C）を参照しました。その例では、放電率0.2Cでの使用時に、電池電圧が1.2Vを下回ると急激に電圧が降下する傾向が見られたため、電池1本あたりの電圧1.2Vを警告の目安としました。  
実動作時の消費電流は10mA～20mA（放電率0.01C程度）と小さいため、警告後も直ちに動作停止することはありません。フロントパネルの赤色LED点灯により、バッテリー交換時期をお知らせします。  
ローバッテリのワーニングが出ても、LEDが点灯するだけで動作に支障はありません。

### 電源回路
バッテリの電圧は使用時間に応じて変化するので、安定した電圧を供給するために3.3Vのレギュレータを使っています。  
ドロップアウト電圧は0.1Vのデバイスを使っていますので、理論的にはバッテリ電圧が3.4Vまで低下しても正常に動作しますが、この電圧はバッテリにとって過放電の状態ですので、ローバッテリのワーニングが出たらバッテリを充電してください。 
バッテリからの電源入力の直近にはポリヒューズを挿入して基板上での電源ショート時に電池を遮断するようにしています。


## 回路図 2/4
### マルチプレクサ回路
24個のコイルを順次切り替えて駆動するためのマルチプレクサ回路です。この回路図では50個のコイルまで駆動できるようにマルチプレクサ回路を組んであります。  
スイッチは8ch切り替えのアナログスイッチをプラス側とマイナス側で1セットとして使います。ICのスイッチを設定する3bitの信号と、IC自身のチップセレクトを組み合わせて50chの切り替えを実行します。スイッチにはリーク電流が少ないタイプのものを選んでいます。スイッチのリーク電流は内部の規制ダイオードによる電源からのリークなので直流であることが想定できます。  
今回の用途では交流駆動なので直流のリーク電流による測定への影響は小さいと考えています。ただ、スイッチのリーク直流がコイルに流れ、磁場が発生している可能性は否定できません。

## 回路図 3/4
### ユーザインターフェイス回路
フロントパネルに出ている、スイッチ、BNCコネクタ、LEDなどユーザへのインターフェイスを提供する部分を集めた部分で、本体とは別の基板に実装されます。メイン基板とはCN7のコネクタで接続します。また、電池からの電源はいったんこの基板上で電源スイッチを経由したのち本体に渡ります。  
同期信号の出力を選択する回路は、BNCコネクタに出力する信号を「フォトカプラでアイソレートされた信号」もしくは「直接ドライブされる信号」にするのかを選択します。これは基板上のジャンパで行うものでフロントパネルから操作はできません。  
その他、電流設定スイッチ、パイロットランプ(LED)、ローバッテリワーニング(LED)が実装されます。


## 回路図 4/4
### 同期信号出力回路
同期信号を出力する回路です。ラインドライブ用のICを用いてドライブ能力を強化しています。また、絶縁信号の出力を用意するためにフォトカプラを使っています。必要に応じて切り替えて使える様してあります。  
フォトカプラによる絶縁出力は、信号の受け側に電源が必要になりますので注意してください。

### スイッチ接続回路
ユーザインターフェイス回路からのスイッチ入力および、表示用LEDのドライブを行う回路です。  
スイッチ入力にはチャタリング除去用のCR回路があります。LEDドライブのためにバッファICを利用しています。

### DDSインターフェイス
DDSの設定のためのシリアルインターフェイス(SPI)がCPLDに実装されており、そこからの信号をDDSに接続しています。 
DDSのクロックをCPLDに渡して、そのクロックからDDSとCPLDの通信に使用するSPI信号を作成しています。SPIの他、DDSを制御するための信号線もCPLDに接続していますが、この設計では積極的に利用していません。

### シーケンス回路（CPLD/HDL）
80Hzのクロック信号を元にマルチプレクサ回路を駆動する、シーケンス回路をCPLDに実装しています。  
詳細についてはHDL設計図書をご覧ください。マルチプレクサ回路の駆動の他に、ユーザインタフェース回路からのスイッチの設定情報から出力電流を設定したり、電源投入時にDDSのイニシャライズをしたりといった機能を実装しています。  
CPLDの電源はアナログ回路へのノイズ流入を防ぐため、アナログ回路とは独立したレギュレータでデジタル部分の電源を作成しています。I/O電圧が3.3V、コア電圧が1.8Vとなっており1.8Vのレギュレータが別途必要になります。  
物理サイズは100ピンのQFPパッケージで、回路規模は160LEです。部品実装作業の簡便さからQFPパッケージを選んでいますが、実装面積が大きくなってしまいました。小型のBGAなどのパッケージもありますのでお好みでご利用ください。  
プログラミング用のJTAG端子はALTERA USB blasterとコンパチビリティがあります。

## ハーネス
筺体内の配線のためのハーネスの詳細については、[ワイヤハーネスの回路図](harness_set.pdf)を参照ください。  
ケーブルは手元に在庫があった潤フロン線(AWG30)をつかっていますが、AWG26〜28程度の細さの線であればなんでもokかと思います。  
バッテリケースからユーザインタフェース回路までの電源ケーブルについてはこの回路図に記載がありません。現物に合わせて作成をお願いします。バッテリケースからの電源引き出しのケーブルはAWG24程度の太めの線を使用しました。ポリヒューズが動作する程度の電流でケーブルが過熱しない様にケーブルの電流容量を見積もってください。
