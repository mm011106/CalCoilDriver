# モニタ出力の値づけ（キャリブレーション）
このノートでは、コイルドライバの電流モニタ出力の電圧値とコイルを流れる電流値の係数（電流電圧変換係数）を実測値から値づけする手順例を示します。  
この作業はコイルに流れる実際の電流値を電流モニタ出力の電圧から把握するために不可欠です。  
この手順は実際に機器を製造するときに用いた方法ですが、他の方法でも値づけは可能だと思いますので参考までにご覧ください。</br>

## 修正履歴
- 初版：2025/07/25  宮本政和
---
# 概要
- キャリブレーション時の機器の接続
(計測のブロック図)

## キャリブレーションの目的

本装置は接続されたコイルを一定の電流で駆動し、その電流値は電流モニタ出力から電圧として観測できる様になっています。このモニタ出力の電圧値は設計された電流電圧変換係数に従いコイルに流れる電流に比例した電圧を発生しますが、部品のばらつき等によるエラーを含んでいます。このエラーを把握し、電流モニタ出力電圧から信頼性の高い電流値を推測するために電流電圧変換係数の値づけ(キャリブレーション)を行います。


値づけのためには、実際にコイルに流れる電流とコイルドライバのモニタ出力の電圧を同時に観測する必要があります。  

この値づけ作業の結果、算出されるのは以下のパラメタです。
- 電流モニタ出力の電流ー電圧変換係数 

## 値づけのための計測
値づけのための計測の概要は以下の通りです。

1. **コイルに流れる電流を直接計測する**  
  本来はコイルに流れている電流を電流計のような測定器で直接計測するのがベターだと思いますが、ここではコイルの代わりに終端抵抗を駆動し、その両端に発生する電圧を測定することで流れている電流を推測します。  
  直流抵抗がほぼゼロのコイルを駆動した時と比較して、発生した電圧の分だけ駆動電流の絶対値は低くなります。しかし、変換係数の値づけに電流の絶対値は関係しないため問題ないと判断しています。（リニアリティは回路・部品で担保されていると想定しています）  
  コイルを駆動した時の電流値については、変換係数の算出後に終端抵抗を0Ωにして確認します。  
  
1. **同時に電流モニタ出力の電圧値を計測する**  
上記の終端抵抗に発生する電圧の計測と同時に、装置の電流モニタ出力の電圧計測します。  
これにより、「同じ電流を2つの方法で測定した結果」を得ることができます。

1. **同時に電流モニタ出力の電圧値を計測する**  
終端抵抗の電圧計測を基準として電流モニタ出力の電圧を値づけする計算を行います。  

---

# 必要機器
- **DMM(抵抗測定)**
  終端抵抗の値を計測します。確度高く計測するために４端子法での計測をお勧めします。
- **信号モニタ用ジグ**
  コイルドライバの出力(SCSIコネクタ)をBNCに変換するためのジグです。計測のために終端抵抗を接続するために使用します。</br>
- **SCSIケーブル**
  信号モニタ用ジグと機器を繋ぐケーブルです</br>
- **終端抵抗(100Ω)**
    ドライブされるコイルのダミーとして使います。100Ωの両端の電圧を計測することで、実際にコイルに流れる電流を算出します。</br>
- **FFTアナライザ**
  コイルドライバのモニタ出力端子と終端抵抗の交流電圧を計測します。非常に小さい電圧（1mVrms程度）を計測するので、ノイズを含めて計測してしまう交流電圧計は使用できません。  
  ロックインアンプでも計測可能だと思います。  
  モニタ出力の電圧値とコイルに流れる電流（終端抵抗の両端の電圧）を同時に計測する必要があるため、2ch同時計測できる計測器が望ましいです。また、測定器の入力は測定器のGNDからフロートしている必要があります。  

---

# 手順

## 0. 注意事項

* **測定環境:** 温度変化などにより抵抗値や回路特性が変動する可能性があるため、安定した環境で測定を行ってください。
* **測定確度:** 使用する計測機器の測定確度がキャリブレーション結果に直接影響します。
## 1. setup
### 本装置を出力固定モードに変更する
本体のUI基板上にある「TEST/NORMAL」切り替えジャンパを「TEST」側に設定します。これにより駆動チャネルが固定されます。 
固定されるチャネルは回路図上の表記で「DRIVE_13」となり、SCSIコネクタ上では「13,38」のペアになります。  
（写真）
### 駆動電流値を設定する
測定する駆動電流をフロントパネルから設定します。
### コイルドライブ出力コネクタに終端抵抗取り付け用のジグを接続
装置の裏側のコネクタに終端抵抗取り付け用のジグを接続します。ここではMEG用の周辺部品として手元にあった、SCSIコネクタをBNCコネクタに接続するジグと、SCSIケーブルを使用しました。  
(写真)

### 動作確認
装置の電源を入れ動作させます。終端抵抗取り付けるジグの端子から信号が連続して出ていることをオシロスコープで確認します。  

## 2. 計測
### 終端抵抗の抵抗値計測
終端抵抗の抵抗値を計測します。可能であれば4端子法を用いて計測すると確度が高い値を得る事ができます。  
この値で駆動電流を算出することになります。

###　モニタ出力と終端抵抗両端の電圧計測
抵抗値を確認した終端抵抗をコイルドライブ出力コネクタに接続したジグに装着し、コイルのダミーとして動作させます。  
この終端抵抗の両端をFFTアナライザの入力に導入し、コイルに流れている実際の電流値として計測します。

同時にモニタ出力端子をFFTアナライザの入力に導入し、コイルに流れている電流を装置で検出した結果として計測します。

FFTには駆動周波数（標準では80Hz）にピークがある信号が検出されているので、そのピーク値を信号電圧とします。  
必要に応じて、平均化などを行い安定した測定値を得てください。

###　変換係数の算出
上記で得られた、終端抵抗の両端の電圧(Vr)とモニタ出力端子の電圧(Vm)、終端抵抗の値(Rt)から変換係数を算出します。  
コイルに流れている電流をId、求めたい電流電圧変換係数をkとすると
\[
  V_r=I_d R_t\\
  V_m=k I_d \\
 \]
 ここから、
 \[
  k=\frac{V_m R_t}{V_r}\\
 \]
となるので、この式から電流電圧変換係数を計算します。
設計値は5033[V/A]です。（実質的に単位は[Ω]ですが、わかりやすさのため[V/A]としておきます）

###　コイルに流れる電流値を測定
ここまでの計測はモニタ出力の電圧とコイルに流れる電流の関係を把握するための計測でしたが、電流検出のためにコイルの代わりに100Ωの終端抵抗をもちいたため、実際の磁場発生のためのコイルを接続した時に流れる電流値とは異なります。ここでは終端抵抗を0Ωにしてコイルに流れる電流値を確認します。  
終端抵抗を取り外し0Ωの抵抗に取り替え、実際のコイルが接続されたのと同様の状況を再現します。これにより実際のコイルに流れる電流値をモニタ出力端子の電圧の計測により算出します。  
この計測で、実際のコイルの駆動電流が意図した通りに実現されているかどうか判断します。

---

#　まとめ
この作業でコイルドライバ回路のモニタ出力電圧に対して値づけ（電流ー電圧変換係数の実測）を行いました。これにより、モニタ出力電圧からコイルに流れている電流値を計算できるようになりました。また、コイルに流れる電流値が設計が意図している電流値であることを確認する事ができました。


<!-- ---
## モニタ回路のキャリブレーション：正確な電流値の把握のために

この解説文では、定電流回路に付属するモニタ回路のキャリブレーション（値づけ）方法についてご説明します。この作業は、コイルに流れる実際の電流値を、モニタ回路の出力電圧から正確に把握するために不可欠です。

---

### 1. キャリブレーションの目的

定電流回路は、コイルに一定の電流を供給するように設計されていますが、モニタ回路が出力する電圧値が、必ずしも実際の電流値を正確に反映しているとは限りません。この誤差を修正し、モニタ回路の出力電圧から信頼性の高い電流値を得るためにキャリブレーションを行います。

---

### 2. キャリブレーションに必要なもの

* **定電流回路本体:** モニタ回路が付属している装置。
* **高精度抵抗:** コイルの代わりに接続し、既知の抵抗値に基づいて電流値を測定するために使用します。抵抗値は、想定される電流値範囲で十分な電圧降下が得られるように選択してください。
* **高精度電圧計（マルチメータ）:** 高精度抵抗の両端電圧、およびモニタ回路の出力電圧を測定するために使用します。
* **接続ケーブル:** 各機器を適切に接続するためのケーブル。 -->

<!-- ---

### 3. キャリブレーションの手順

#### 3.1. 測定準備

1.  **コイルの取り外しと抵抗の接続:** 定電流回路から実際のコイルを取り外し、その代わりに高精度抵抗を接続します。この抵抗に流れる電流が、実測される電流の基準となります。
2.  **電圧計の接続:**
    * 一つ目の電圧計を高精度抵抗の両端に並列に接続します。この電圧計で測定される電圧と抵抗値から、抵抗に流れる電流（＝コイルに流れると見なす電流）を算出します。
    * 二つ目の電圧計をモニタ回路の出力端子に接続します。

#### 3.2. 電流値と出力電圧の測定

1.  **電流設定と測定:** 定電流回路の電流設定を段階的に変化させ、それぞれの設定値で以下の測定を同時に行います。
    * 高精度抵抗の両端電圧 ($V_R$) を測定します。
    * モニタ回路の出力電圧 ($V_{MON}$) を測定します。
2.  **実電流値の算出:** 測定した高精度抵抗の電圧 ($V_R$) と抵抗値 ($R$) から、オームの法則（$I = V_R / R$）を用いて、その時の実際の電流値 ($I_{ACTUAL}$) を算出します。

#### 3.3. データ分析とキャリブレーションカーブの作成

1.  **データ記録:** 各電流設定値における $I_{ACTUAL}$ と $V_{MON}$ のペアを記録します。
2.  **グラフ作成:** 縦軸に $I_{ACTUAL}$、横軸に $V_{MON}$ をとり、測定データをプロットします。
3.  **近似曲線の導出:** プロットされた点から、直線または多項式などの近似曲線を導き出します。この近似曲線が、モニタ回路の出力電圧 ($V_{MON}$) から実際の電流値 ($I_{ACTUAL}$) を推定するためのキャリブレーションカーブとなります。理想的には、直線的な関係が得られるはずです。

---

### 4. キャリブレーション結果の活用

キャリブレーションカーブが得られれば、以降はモニタ回路の出力電圧 ($V_{MON}$) を測定するだけで、その時のコイルに流れる実際の電流値を推定できるようになります。これにより、装置の動作状況をより正確に把握し、制御することが可能になります。

---

### 5. 注意事項

* **測定環境:** 温度変化などにより抵抗値や回路特性が変動する可能性があるため、安定した環境で測定を行ってください。
* **測定精度:** 使用する電圧計や抵抗の精度がキャリブレーション結果に直接影響します。可能な限り高精度の機器を使用してください。
* **定期的な再キャリブレーション:** 装置の使用状況や経年変化によって特性が変化する可能性があるため、定期的な再キャリブレーションを推奨します。

---

ご不明な点がございましたら、お気軽にお尋ねください。 -->
