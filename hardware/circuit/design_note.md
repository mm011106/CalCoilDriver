# 設計ノート
このノートは当該機器の電子回路設計の履歴や設計意図を記録しています。</br>
回路動作の理解や改善・修理などにご利用ください

## 修正履歴
- 初版：2025/06/01  宮本政和

## 設計の概要
### 設計のポイント
- バッテリ動作
    単三バッテリ4本で動作するように設計しました。ACでの駆動は磁気計測環境に対してノイズを導入する可能性があるため、信頼性の高い計測が必要なキャリブレーションには向かないと判断しました。
    コイルドライブ部の駆動電圧は3.3Vですが、出力をプッシュプル構成とすることで動作電圧が低いという欠点を補っています。

- DDSを発振器として利用
  従来のコイルドライバではアナログの発振器を使用していましたが、この設計ではDDSに変更しました。これにより周波数変更作業が容易になります。従来ですと、発振回路の抵抗器を調整しながら交換する必要がありましたが、この設計ではCPLDに書き込むHDLの変更（ソフトでの対応）で済む様になりました。
  一方、DDSという高周波で動くデジタル回路を内蔵させましたので、ノイズの流入に注意して設計しました。

  アナログの発振回路も回路図上は残っていますので、必要に応じて利用可能です。

- コイル駆動電流を計測できる様にモニタ端子を用意する
  キャリブレーション作業では、コイルに流れる電流を計測する必要があります。そのための電流モニタ回路を用意しました。
  コイルに流れる電流値をアナログ電圧として計測することが可能です。さらに、実際にコイルに流れている電流を別法により計測することで、電流モニタ回路出力の値を校正（値付け：あたいづけ）することができます。
  電流モニタ回路は安定した計測結果を得るために、温度特性の良い部品を使っています。
  

### 発振回路(DDS)
#### 設計のポイント
発振回路そのものは、市販のモジュールを利用しています。DDSでは周波数決定のためのレジスタに設定する値と、デバイスに接続している水晶発振子の発振周波数から出力される信号の周波数が決定されます。そのため、例えば周波数設定値のLSB1ビット分を0.1Hzにする、と言ったような「キリのいい」設定にしようとすると、水晶発振子の周波数が2^24/10のような値になってしまい、特注品での購入になってしまいます。そうするとコストも納期もかかってしまうので、市販のモジュールを使用することにしました。

使用したモジュールは ストロベリーLinuxという会社の「AD9834 小型DDSモジュールキット」という製品で、AnalogDevicesのAD9384というDDS-ICに特注の水晶発振子を実装して、周波数設定の1LSBあたり0.25Hzとキリのいい周波数設定で、出力信号の周波数を設定できるようになっています。

また、出力信号が差動で得られるのでノイズ対策にも有利です。

#### デバイス仕様・定数の決定
回路図にはこのDDSモジュールの設定について記載していないので、ここに記載しておきます。
- [ストロベリーLinux　　AD9834 小型DDSモジュールキット](https://strawberry-linux.com/catalog/items?code=57090)
- 周波数設定　CPLDのプログラミングによる（デフォルト：80Hz）
- 出力信号 差動出力　0.5Vp-p
  - これを本体側の差動アンプ（ゲインx1）回路で受けるので、本体側の信号レベルとしては2倍の1Vp-pになります。
  - 出力設定のために、本体上の出力電圧設定抵抗（FSADJ端子につながっている6.8kΩの抵抗）を取り外し、8.2kΩを取り付けます。（ !!!抵抗値の確認をすること!!!）
- 電源電圧　5V（バッテリ4本の電圧をそのまま供給していますので、正確には4.8Vtypとなります）
  - 3.3Vでの動作を試みましたが、外部との通信がうまくいかないケースがあり、5Vとしました　（!!!回路確認のこと!!!）