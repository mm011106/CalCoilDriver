# 設計ノート
このノートは当該機器の電子回路設計の履歴や設計意図を記録しています。</br>
回路動作の理解や改善・修理などにご利用ください

## 修正履歴
- 初版：2025/06/01  宮本政和

# 設計の概要
## ブロック図

## 設計のポイント
- バッテリ動作
    単三バッテリ4本で動作するように設計しました。<br></br>
    ACでの駆動は磁気計測環境に対してノイズを導入する可能性があるため、信頼性の高い計測が必要なキャリブレーションには向かないと判断しました。
    コイルドライブ部の駆動電圧は3.3Vですが、出力をプッシュプル構成とすることで動作電圧が低いという欠点を補っています。

- DDSを発振器として利用
  従来のコイルドライバではアナログの発振器を使用していましたが、この設計ではDDSに変更しました。<br></br>
  これにより周波数変更作業が容易になります。従来、周波数変更のためには発振回路の抵抗器の交換が必要でしたが、この設計ではCPLDに書き込むHDLの変更（ソフトでの対応）で済む様になりました。
  一方、DDSは高周波で動くデジタル回路ですので、コイルドライブ回路へのノイズの流入に注意して設計しました。

  アナログの発振回路も回路図上は残っていますので、必要に応じて利用可能です。

- コイル駆動電流を計測できる様にモニタ端子を用意しました。<br></br>
  キャリブレーション作業では、コイルに流れる電流を計測する必要があります。そのための電流モニタ回路を用意しました。
  コイルに流れる電流値をアナログ電圧として計測することが可能です。さらに、実際にコイルに流れている電流を別法により計測することで、電流モニタ回路出力の値を校正（値付け：あたいづけ）することができます。
  電流モニタ回路は安定した計測結果を得るために、温度特性の良い部品を使っています。
  
# 各部の詳細設計
## 発振回路(DDS)
### 設計のポイント
発振回路そのものは、市販のモジュールを利用しています。DDSでは周波数決定のためのレジスタに設定する値と、デバイスに接続している水晶発振子の発振周波数から出力される信号の周波数が決定されます。そのため、例えば周波数設定値のLSB1ビット分を0.1Hzにする、と言ったような「キリのいい」設定にしようとすると、水晶発振子の周波数が2^24/10のような値になってしまい、特注品での購入になってしまいます。そうするとコストも納期もかかってしまうので、市販のモジュールを使用することにしました。

使用したモジュールは ストロベリーLinuxという会社の「AD9834 小型DDSモジュールキット」という製品で、AnalogDevicesのAD9384というDDS-ICに特注の水晶発振子を実装して、周波数設定の1LSBあたり0.25Hzとキリのいい周波数設定で、出力信号の周波数を設定できるようになっています。

また、出力信号が差動で得られるのでノイズ対策にも有利です。

### デバイス仕様・定数の決定
回路図にはこのDDSモジュールの設定について記載していないので、ここに記載しておきます。
- [ストロベリーLinux　　AD9834 小型DDSモジュールキット](https://strawberry-linux.com/catalog/items?code=57090)
- 周波数設定　CPLDのプログラミングによる（デフォルト：80Hz）
- 出力信号 差動出力　0.5Vp-p
  - これを本体側の差動アンプ（ゲインx1）回路で受けるので、本体側の信号レベルとしては2倍の1Vp-p(=0.5Vo-p)になります。
  - 出力設定のために、本体上の出力電圧設定抵抗（FSADJ端子につながっている6.8kΩの抵抗）を取り外し、8.66kΩ(=9.1kΩ//180kΩ)を取り付けます。
  - 信号はDDSモジュール上のSMBコネクタのパターン上からリード線を引き出しDF11コネクタを取付け、本体回路のCN1と接続しています。
- 電源電圧　3.3V
  - モジュール自の仕様としては電源電圧5Vです。初期の設計でDDSを5V動作に設定して動作確認したところ、CPLDのIO電圧が3.3VであるためDDSがCPLDからのコマンドを受け取れないという状況になりました。そのため、3.3V動作としています。
  - 使用しているDDSデバイスの電源範囲は2.3〜5.5Vなので問題ないですが、使用している水晶発振器の電源電圧が5Vとなっています。実際に動作テストを行い、3.3Vでも問題ないことを確認してこの電源電圧で使用しています。

## 本体回路
本体の回路は以下のような機能が実装されています。

- アナログ発振回路（未使用）
- 外部入力回路（未使用）
- DDS信号入力回路
- 入力選択回路（固定で使用）
- シーケンス駆動用クロック信号生成回路（コンパレータ）
- ドライブ回路／電流設定回路
- 電流検出回路
- 中間電位生成回路
- バッテリ電圧監視回路
- 同期信号出力回路
- ユーザインターフェイス回路
- シーケンス回路（CPLD/HDL）
- 電源回路

以下に、各部の設計の詳細について記載します。

<img src="ER-524D_CoilDriver24_SCH.pdf" alt="3DPerspective" width="400px">

### アナログ発振回路（未使用） (U1A,U1B)
コイルを駆動する信号を生成するアナログの発振回路です。今回の設計では使いませんが、旧バージョンとのコンパチビリティのために基板上にパターンが存在します。

部品を実装すれば利用可能です。発振可能な周波数範囲としては10Hzぐらいから20kHz程度かと思います。ドライブ回路ではノイズ対策のためLPFが入っていますので、周波数を変更する場合はその調整も行ってください。

出力電圧は1Vo-pに調整します。

### 外部入力回路（未使用） (U2A)
コイルを駆動する信号を外部から入力するための回路です。差動アンプで受けることで外部の発振器からのノイズ流入を抑えています。

1Vo-p入力時に設計した駆動電流となります。

### DDS信号入力回路 (U2B)
DDSのアナログ出力を受け取ります。DDSからのノイズ流入を防ぐため、GNDを直接接続しない差動アンプで受け取ります。差動アンプの利得は1倍ですが、DDSの出力も差動なのでDDSの設定電圧の2倍の電圧が出力されます。
ノイズを抑えるため、1kHz程度のLPFがかかっています。

### 入力選択回路（固定で使用） (U3-1,U3-2)
アナログスイッチを用いて、コイルを駆動する信号をCPLDの信号により選択します。DDS、アナログ発振回路、外部入力の3つの選択肢があります。
今回の設計では、CPLD内部でDDSに固定されています。

### シーケンス駆動用クロック信号生成回路（コンパレータ） (U7)
複数のコイルを決まったパターンで順次ドライブするために、シーケンス回路が必要となります。そのシーケンス回路の動作タイミングの基準となるクロックを発振回路の出力信号から作成するのがこの回路です。

単純なヒステリシス付きコンパレータで、発振回路の出力の正弦波から矩形波を作成し、CPLD内のシーケンス回路に渡します。

ヒステリシスは41mVに設定してあります。このヒステリシスで現在のところ問題は発生していません。

### ドライブ回路／電流設定回路 (U5A,U10X,U8A,U8B)
入力選択回路からの正弦波はドライブ回路に入ります。入力電圧は0.5Vo-pです。
アナログ発振回路からの信号は1Vo-pなので、入力で1/2にアッテネートされます。DDS入力の場合はそのまま入力されます。

最初にU5AとU10Xの非反転アンプで出力電流設定に応じて、1倍もしくは2倍に振幅を増幅します。

その後、プッシュプル動作のドライブ回路(U8A,U8B)に信号が渡されます。ここでは1倍の反転アンプと1倍の非反転アンプの構成でプッシュプル（差動）出力の信号を作成します。ノイズ防止のため1.4kHz程度のLPFがかかっています。

プッシュプル出力の信号はそれぞれU9のアナログスイッチを通して出力電流を決める抵抗に接続されます。ここでは２つの出力インピーダンスを切り替えて電流出力を設定しています。この設計では2つのインピーダンスの比は10倍です。
この設計では定電流駆動回路の構成は取りませんでした。接続されるコイルが既知の仕様のものであり、インピーダンスが十分低いことがその理由です。定電流駆動回路は、負荷のインピーダンスが未知だったり、ばらつきが大きいものを安定して定電流で駆動することができます。その一方で回路が複雑になり信号に対する応答特性を考慮する必要があること、3.3Vという低電圧動作のため定電流駆動回路の利点が引き出せない可能性があることから、単純な高出力インピーダンスによる電流出力としました。

電流の切り替えは、最初の非反転アンプU5Aでの電圧での切り替えと、この出力インピーダンスの切り替えの2箇所で行うことになります。それぞれ1bitの切り替え選択肢なので、4つの設定ができることになります。

出力インピーダンスを下げることによってドライブ電流を上げることができますが、オペアンプのドライブ能力の点から5mA程度が最大となります。また、インピーダンスを下げるとコイル接続部の接触抵抗などによるドライブ電流誤差が大きくなると考えられます。ドライブ電流は計測できるので大きな問題にはならないと思いますが、計測の安定性や信頼性を考えるとコイルのインピーダンスの100倍程度の出力インピーダンスは維持した方がいいと思われます。

### 電流検出回路(U11)
コイルの駆動電流を検出する回路です。高精度の100Ω抵抗をコイル駆動経路に挿入し、高利得確度のインスツルメンテーションアンプICを利用してその両端の電圧を測ることで電流を測定することを可能にします。

インスツルメンテーションアンプの利得は高安定度の抵抗2本の並列接続(R55,R57)で設定しています。利得は50.33倍に設定されます。100Ωの検出抵抗を使っているので、電流電圧変換係数としては5033[V/I]となります。
 
10uA設定時に電流検出回路出力は50.33mVになります。

<!-- 電流電圧変換係数の誤差は、インスツルメンテーションアンプの利得誤差（0.3%最大）、利得設定抵抗の抵抗値誤差（0.05%最大）、電流検出抵抗100Ωの誤差(0.05%最大)から見積もれますが、これは理想的な状況を仮定した場合だと考えられます。実際には部品実装時の熱ストレスやハンダ付けによる機械的なストレスが加わっており、部品単体の仕様で提示された誤差よりも 大きくなる可能性があります。
完成後にコイル駆動電流値と電流検出回路の出力の電流の両方を同時に計測することにより電流電圧変換係数の値付をする必要があると考えます。
-->

### 中間電位生成回路

### バッテリ電圧監視回路
- 同期信号出力回路
- ユーザインターフェイス回路
- シーケンス回路（CPLD/HDL）
- 電源回路
